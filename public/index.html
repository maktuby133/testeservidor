<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Caixa d'√Ågua</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #1a2a6c;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
            font-weight: 800;
        }

        .connection-status {
            text-align: center;
            margin: 15px 0;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .connected {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
        }

        .disconnected {
            background: linear-gradient(135deg, #FF4500, #DC143C);
            color: white;
            animation: pulse 2s infinite;
        }

        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-top: 25px;
        }

        .tank-section {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tank-container {
            position: relative;
            width: 320px;
            height: 420px;
            margin-bottom: 20px;
        }

        .tank-image {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 2;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            object-fit: cover;
        }

        .water-container {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 300px;
            z-index: 3;
            overflow: hidden;
            border-radius: 12px 12px 6px 6px;
            background: rgba(255, 255, 255, 0.1);
        }

        .water-level {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            border-radius: 12px 12px 0 0;
            transition: height 1.5s ease-in-out;
            background: linear-gradient(to bottom, #0077ff, #00c8ff);
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .percentage-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.8);
            z-index: 4;
        }

        .info-section {
            flex: 2;
            min-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .data-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .card {
            background: linear-gradient(135deg, #1a2a6c, #2a3a9c);
            color: white;
            padding: 20px 15px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(26, 42, 108, 0.3);
            text-align: center;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(26, 42, 108, 0.4);
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 10px 0;
        }

        .card-label {
            font-size: 1rem;
            font-weight: 600;
            opacity: 0.9;
        }

        .status-container {
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            border: 2px solid;
        }

        .critical {
            background: linear-gradient(135deg, #ff3232, #ff6464);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .warning {
            background: linear-gradient(135deg, #ffa500, #ffc800);
            color: white;
        }

        .normal {
            background: linear-gradient(135deg, #32cd32, #90ee90);
            color: white;
        }

        .full {
            background: linear-gradient(135deg, #1e90ff, #87cefa);
            color: white;
        }

        .consumo-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            border: 2px solid rgba(26, 42, 108, 0.2);
        }

        .consumo-title {
            font-size: 1.3rem;
            color: #1a2a6c;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 800;
        }

        .graficos-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .grafico-box {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid rgba(26, 42, 108, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .grafico-content {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #dee2e6;
            display: flex;
            align-items: end;
            gap: 3px;
        }

        .barra-horizontal {
            display: flex;
            align-items: end;
            gap: 3px;
            height: 120px;
            width: 100%;
        }

        .barra-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: end;
            height: 100%;
            position: relative;
        }

        .barra {
            width: 80%;
            background: linear-gradient(to top, #1a2a6c, #4169E1);
            border-radius: 3px 3px 0 0;
            min-height: 2px;
            transition: height 0.3s ease;
        }

        .barra-semana {
            width: 80%;
            background: linear-gradient(to top, #228B22, #32CD32);
            border-radius: 3px 3px 0 0;
            min-height: 2px;
            transition: height 0.3s ease;
        }

        .barra-valor {
            font-size: 0.6rem;
            font-weight: 700;
            color: #1a2a6c;
            margin-top: 3px;
            text-align: center;
        }

        .barra-hora {
            font-size: 0.6rem;
            font-weight: 600;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        .horas-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.7rem;
            color: #666;
        }

        .semanas-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.65rem;
            color: #666;
        }

        .config-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF4500, #DC143C);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4169E1, #1E90FF);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .update-info {
            text-align: center;
            margin-top: 20px;
            font-size: 0.85rem;
            color: #666;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            .tank-container {
                width: 280px;
                height: 360px;
            }
            .water-container {
                width: 150px;
                height: 250px;
            }
            .info-section {
                min-width: 100%;
            }
            .graficos-container {
                grid-template-columns: 1fr;
            }
            .config-buttons {
                flex-direction: column;
                align-items: center;
            }
            .btn {
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíß MONITOR CAIXA D'√ÅGUA</h1>
        
        <div class="connection-status" id="connectionStatus">
            üîÑ Conectando...
        </div>

        <div class="dashboard">
            <div class="tank-section">
                <div class="tank-container">
                    <img src='https://i.ibb.co/8nHcd2FZ/TANK-Photoroom.png' alt='Caixa d√°gua' class="tank-image">
                    <div class="water-container">
                        <div class="water-level" id="waterLevel" style="height: 0%"></div>
                    </div>
                    <div class="percentage-display" id="percentageDisplay">0%</div>
                </div>
            </div>
            
            <div class="info-section">
                <div class="data-cards">
                    <div class="card">
                        <div class="card-value" id="levelValue">0 cm</div>
                        <div class="card-label">N√≠vel √Ågua</div>
                    </div>
                    <div class="card">
                        <div class="card-value" id="litersValue">0 L</div>
                        <div class="card-label">Volume Atual</div>
                    </div>
                    <div class="card">
                        <div class="card-value" id="consumoHora">0 L</div>
                        <div class="card-label">Consumo/Hora</div>
                    </div>
                    <div class="card">
                        <div class="card-value" id="consumoHoje">0 L</div>
                        <div class="card-label">Consumo/Hoje</div>
                    </div>
                </div>
                
                <div class="status-container normal" id="statusContainer">
                    <div id="statusText">üîÑ Inicializando...</div>
                </div>

                <div class="consumo-section">
                    <div class="consumo-title">üìä HIST√ìRICO DE CONSUMO</div>
                    
                    <div class="graficos-container">
                        <div class="grafico-box">
                            <h3>‚è∞ √öltimas 24 Horas</h3>
                            <div class="grafico-content">
                                <div class="barra-horizontal" id="grafico24h">
                                    <!-- Barras ser√£o geradas aqui -->
                                </div>
                            </div>
                            <div class="horas-labels" id="horasLabels24h">
                                <!-- Labels das horas -->
                            </div>
                        </div>

                        <div class="grafico-box">
                            <h3>üìÖ √öltimas 5 Semanas</h3>
                            <div class="grafico-content">
                                <div class="barra-horizontal" id="grafico5s">
                                    <!-- Barras ser√£o geradas aqui -->
                                </div>
                            </div>
                            <div class="semanas-labels" id="labels5s">
                                <!-- Labels das semanas -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="config-buttons">
            <button class="btn btn-primary" onclick="sendCommand('get_data')">
                üîÑ Atualizar Dados
            </button>
            <button class="btn btn-danger" onclick="resetConsumo()">
                üóëÔ∏è Resetar Consumo
            </button>
            <button class="btn btn-secondary" onclick="sendCommand('restart_ap')">
                üì° Modo Config
            </button>
        </div>

        <div class="update-info">
            √öltima atualiza√ß√£o: <span id="lastUpdate">--:--:--</span>
        </div>
    </div>

    <script>
        // ====== VARI√ÅVEIS GLOBAIS ======
        let ws = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;

        // ====== CONEX√ÉO WEBSOCKET ======
        function connectWebSocket() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                
                console.log('üîÑ Tentando conectar WebSocket:', wsUrl);
                updateConnectionStatus('üîÑ Conectando...', 'disconnected');
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    console.log('‚úÖ WebSocket conectado com sucesso!');
                    isConnected = true;
                    reconnectAttempts = 0;
                    updateConnectionStatus('‚úÖ Conectado ao ESP32', 'connected');
                    
                    // Solicitar dados iniciais
                    setTimeout(() => {
                        sendCommand('get_data');
                        sendCommand('get_consumo');
                        sendCommand('get_consumo_semanal');
                    }, 1000);
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üì® Mensagem recebida:', data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('‚ùå Erro ao processar mensagem:', error);
                    }
                };
                
                ws.onclose = function(event) {
                    console.log('‚ùå WebSocket fechado:', event.code, event.reason);
                    isConnected = false;
                    updateConnectionStatus('‚ùå Desconectado', 'disconnected');
                    
                    // Tentar reconectar
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        console.log(`üîÑ Tentativa ${reconnectAttempts} de reconex√£o em 3s...`);
                        setTimeout(connectWebSocket, 3000);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('‚ùå Erro WebSocket:', error);
                    updateConnectionStatus('‚ùå Erro de conex√£o', 'disconnected');
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao conectar WebSocket:', error);
                updateConnectionStatus('‚ùå Erro de conex√£o', 'disconnected');
            }
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'all_data':
                    updateMainData(data);
                    break;
                case 'consumo_data':
                    updateConsumoCharts(data);
                    break;
                case 'consumo_semanal_data':
                    updateConsumoSemanalCharts(data);
                    break;
                case 'connected':
                    console.log('‚úÖ Conectado ao servidor, Client ID:', data.clientId);
                    break;
                default:
                    console.log('üì® Mensagem n√£o tratada:', data);
            }
        }

        function updateConnectionStatus(message, status) {
            const element = document.getElementById('connectionStatus');
            element.textContent = message;
            element.className = `connection-status ${status}`;
        }

        // ====== FUN√á√ïES DE ATUALIZA√á√ÉO DA INTERFACE ======
        function updateMainData(data) {
            // Atualizar n√≠vel da √°gua
            const percentage = data.percentage || 0;
            document.getElementById('percentageDisplay').textContent = percentage + '%';
            document.getElementById('waterLevel').style.height = percentage + '%';
            
            // Atualizar valores principais
            document.getElementById('levelValue').textContent = (data.height || 0) + ' cm';
            document.getElementById('litersValue').textContent = (data.liters || 0) + ' L';
            document.getElementById('consumoHora').textContent = (data.consumo_hora || 0) + ' L';
            document.getElementById('consumoHoje').textContent = (data.consumo_hoje || 0) + ' L';
            
            // Atualizar status
            updateStatus(data);
            
            // Atualizar hora da √∫ltima atualiza√ß√£o
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('pt-BR');
        }

        function updateStatus(data) {
            const statusElement = document.getElementById('statusText');
            const container = document.getElementById('statusContainer');
            
            let statusText = '';
            let statusClass = 'normal';
            
            if (!data.sensor_ok) {
                statusText = 'üö® ERRO NO SENSOR';
                statusClass = 'critical';
            } else if (data.percentage < 10) {
                statusText = 'üî¥ N√çVEL CR√çTICO';
                statusClass = 'critical';
            } else if (data.percentage < 30) {
                statusText = 'üü° N√çVEL BAIXO';
                statusClass = 'warning';
            } else if (data.percentage < 80) {
                statusText = 'üü¢ N√çVEL NORMAL';
                statusClass = 'normal';
            } else {
                statusText = 'üîµ N√çVEL CHEIO';
                statusClass = 'full';
            }
            
            statusElement.textContent = statusText;
            container.className = `status-container ${statusClass}`;
        }

        // ====== FUN√á√ïES DOS GR√ÅFICOS ======
        function updateConsumoCharts(data) {
            if (data.consumo_diario) {
                create24hChart(data.consumo_diario);
            }
        }

        function updateConsumoSemanalCharts(data) {
            if (data.consumo_semanal && data.semanas_consumo) {
                createWeeklyChart(data.consumo_semanal, data.semanas_consumo);
            }
        }

        function create24hChart(consumoData) {
            const container = document.getElementById('grafico24h');
            const labelsContainer = document.getElementById('horasLabels24h');
            
            if (!container || !labelsContainer) return;
            
            // Limpar containers
            container.innerHTML = '';
            labelsContainer.innerHTML = '';
            
            // Encontrar valor m√°ximo para escala
            const maxValue = Math.max(...consumoData, 10);
            let totalConsumo = 0;
            
            // Criar barras e labels
            for (let i = 0; i < 24; i++) {
                const consumo = consumoData[i] || 0;
                totalConsumo += consumo;
                
                // Calcular altura da barra (m√≠nimo 2% para visualiza√ß√£o)
                const height = Math.max((consumo / maxValue) * 100, 2);
                
                // Criar container da barra
                const barContainer = document.createElement('div');
                barContainer.className = 'barra-container';
                
                // Criar barra
                const barra = document.createElement('div');
                barra.className = 'barra';
                barra.style.height = height + '%';
                barra.title = `Hora ${i}:00 - ${consumo}L`;
                
                // Criar valor
                const valor = document.createElement('div');
                valor.className = 'barra-valor';
                valor.textContent = consumo > 0 ? consumo + 'L' : '';
                
                barContainer.appendChild(barra);
                barContainer.appendChild(valor);
                container.appendChild(barContainer);
                
                // Criar label da hora
                const label = document.createElement('div');
                label.className = 'barra-hora';
                label.textContent = i + 'h';
                labelsContainer.appendChild(label);
            }
            
            console.log('üìä Gr√°fico 24h atualizado. Total:', totalConsumo + 'L');
        }

        function createWeeklyChart(consumoData, semanas) {
            const container = document.getElementById('grafico5s');
            const labelsContainer = document.getElementById('labels5s');
            
            if (!container || !labelsContainer) return;
            
            // Limpar containers
            container.innerHTML = '';
            labelsContainer.innerHTML = '';
            
            // Encontrar valor m√°ximo para escala
            const maxValue = Math.max(...consumoData, 10);
            let totalConsumo = 0;
            
            // Criar barras e labels
            for (let i = 0; i < 5; i++) {
                const consumo = consumoData[i] || 0;
                totalConsumo += consumo;
                const semanaLabel = semanas[i] || `Sem ${i+1}`;
                
                // Calcular altura da barra (m√≠nimo 2% para visualiza√ß√£o)
                const height = Math.max((consumo / maxValue) * 100, 2);
                
                // Criar container da barra
                const barContainer = document.createElement('div');
                barContainer.className = 'barra-container';
                
                // Criar barra
                const barra = document.createElement('div');
                barra.className = 'barra-semana';
                barra.style.height = height + '%';
                barra.title = `${semanaLabel} - ${consumo}L`;
                
                // Criar valor
                const valor = document.createElement('div');
                valor.className = 'barra-valor';
                valor.textContent = consumo > 0 ? consumo + 'L' : '';
                
                barContainer.appendChild(barra);
                barContainer.appendChild(valor);
                container.appendChild(barContainer);
                
                // Criar label da semana
                const label = document.createElement('div');
                label.className = 'barra-hora';
                label.textContent = semanaLabel;
                labelsContainer.appendChild(label);
            }
            
            console.log('üìÖ Gr√°fico semanal atualizado. Total:', totalConsumo + 'L');
        }

        // ====== FUN√á√ïES DE CONTROLE ======
        function sendCommand(command) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                console.log('üì§ Enviando comando:', command);
                ws.send(command);
            } else {
                console.log('‚ùå WebSocket n√£o conectado. Tentando reconectar...');
                updateConnectionStatus('‚ùå N√£o conectado - Tentando reconectar...', 'disconnected');
                connectWebSocket();
                
                // Tentar enviar novamente ap√≥s 2 segundos
                setTimeout(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(command);
                    } else {
                        alert('‚ùå N√£o foi poss√≠vel conectar ao ESP32. Verifique a conex√£o.');
                    }
                }, 2000);
            }
        }

        function resetConsumo() {
            if (confirm('üóëÔ∏è Tem certeza que deseja resetar TODO o hist√≥rico de consumo?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
                console.log('üîÑ Solicitando reset de consumo...');
                sendCommand('reset_consumo');
                
                // For√ßar atualiza√ß√£o dos dados ap√≥s reset
                setTimeout(() => {
                    sendCommand('get_data');
                    sendCommand('get_consumo');
                    sendCommand('get_consumo_semanal');
                }, 1000);
            }
        }

        // ====== INICIALIZA√á√ÉO ======
        function initializeCharts() {
            // Inicializar gr√°ficos com dados vazios
            create24hChart(new Array(24).fill(0));
            createWeeklyChart(new Array(5).fill(0), ['S1', 'S2', 'S3', 'S4', 'S5']);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Monitor Caixa d√Ågua...');
            
            // Inicializar gr√°ficos
            initializeCharts();
            
            // Conectar WebSocket
            connectWebSocket();
            
            // Atualizar dados a cada 5 segundos
            setInterval(() => {
                if (isConnected) {
                    sendCommand('get_data');
                }
            }, 5000);
            
            // Tentar reconex√£o peri√≥dica
            setInterval(() => {
                if (!isConnected && reconnectAttempts < maxReconnectAttempts) {
                    console.log('üîÑ Tentando reconex√£o peri√≥dica...');
                    connectWebSocket();
                }
            }, 10000);
        });

        // ====== TRATAMENTO DE ERROS GLOBAIS ======
        window.addEventListener('error', function(event) {
            console.error('‚ùå Erro global:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('‚ùå Promise rejeitada:', event.reason);
        });
    </script>
</body>
</html>
