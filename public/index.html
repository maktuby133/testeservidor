<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor LoRa - Caixas d'√Ågua</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 800;
        }
        
        .header p {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .status-bar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-item {
            text-align: center;
            flex: 1;
        }
        
        .status-value {
            font-size: 28px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }
        
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .device-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        
        .device-card:hover {
            transform: translateY(-5px);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .device-id {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }
        
        .device-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-online {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-offline {
            background: #ffebee;
            color: #c62828;
        }
        
        .device-data {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .data-item {
            flex: 1;
            text-align: center;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
        }
        
        .data-value {
            font-size: 24px;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .data-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        
        .signal-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 12px;
            color: #666;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .signal-bars {
            display: flex;
            gap: 2px;
            height: 12px;
        }
        
        .signal-bar {
            width: 4px;
            background: #ddd;
            border-radius: 1px;
        }
        
        .signal-bar.active {
            background: #4caf50;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }
        
        .logs-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-time {
            color: #666;
            margin-right: 10px;
        }
        
        .log-info {
            color: #2196f3;
        }
        
        .log-warn {
            color: #ff9800;
        }
        
        .log-error {
            color: #f44336;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .connected {
            background: #4caf50;
            color: white;
        }
        
        .disconnected {
            background: #f44336;
            color: white;
        }
        
        @media (max-width: 768px) {
            .status-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .device-data {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíß Monitor LoRa - Caixas d'√Ågua</h1>
            <p>Monitoramento remoto em tempo real</p>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-value" id="totalDevices">0</div>
                <div class="status-label">Dispositivos Ativos</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="totalPackets">0</div>
                <div class="status-label">Pacotes Recebidos</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="avgSignal">--</div>
                <div class="status-label">Sinal M√©dio (dBm)</div>
            </div>
            <div class="status-item">
                <div class="status-value" id="lastUpdate">--:--</div>
                <div class="status-label">√öltima Atualiza√ß√£o</div>
            </div>
        </div>
        
        <div id="devicesContainer" class="devices-grid">
            <!-- Dispositivos ser√£o renderizados aqui -->
            <div class="no-devices">
                <p>Nenhum dispositivo conectado...</p>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">üìà Hist√≥rico de N√≠vel</div>
            <canvas id="levelChart" height="100"></canvas>
        </div>
        
        <div class="logs-container">
            <div class="chart-title">üìù Logs do Sistema</div>
            <div id="logs"></div>
        </div>
    </div>
    
    <div id="connectionStatus" class="connection-status disconnected">
        üîå Desconectado
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configura√ß√µes
        const WS_SERVER = window.location.hostname === 'localhost' 
            ? `ws://${window.location.hostname}:3000`
            : `wss://${window.location.hostname}`;
        
        // Estado global
        let ws = null;
        let devices = {};
        let logs = [];
        let levelChart = null;
        
        // Inicializar conex√£o WebSocket
        function connectWebSocket() {
            ws = new WebSocket(WS_SERVER);
            
            ws.onopen = function() {
                console.log('‚úÖ Conectado ao servidor');
                updateConnectionStatus(true);
                addLog('Conectado ao servidor', 'info');
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (error) {
                    console.error('Erro ao processar mensagem:', error);
                }
            };
            
            ws.onclose = function() {
                console.log('‚ùå Desconectado do servidor');
                updateConnectionStatus(false);
                addLog('Desconectado do servidor', 'warn');
                
                // Tentar reconectar ap√≥s 5 segundos
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                console.error('Erro WebSocket:', error);
                addLog('Erro de conex√£o', 'error');
            };
        }
        
        // Manipular mensagens do servidor
        function handleServerMessage(data) {
            switch(data.type) {
                case 'welcome':
                    console.log('Servidor:', data.message);
                    addLog('Conectado ao servidor de monitoramento', 'info');
                    break;
                    
                case 'lora_data':
                    updateDeviceData(data);
                    addLog(`Dados de ${data.device_id}: ${data.percentage}%`, 'info');
                    break;
                    
                case 'devices_list':
                    devices = data.devices;
                    renderDevices();
                    updateStats();
                    break;
                    
                case 'receiver_update':
                    addLog(`Receptor atualizado: ${data.data.packets_received} pacotes`, 'info');
                    break;
                    
                case 'server_status':
                    updateServerStats(data);
                    break;
            }
        }
        
        // Atualizar dados do dispositivo
        function updateDeviceData(data) {
            const deviceId = data.device_id;
            
            if (!devices[deviceId]) {
                devices[deviceId] = {
                    id: deviceId,
                    lastSeen: new Date(),
                    history: [],
                    lastData: data
                };
            }
            
            // Atualizar dispositivo
            devices[deviceId].lastSeen = new Date();
            devices[deviceId].lastData = data;
            
            // Adicionar ao hist√≥rico
            if (!devices[deviceId].history) {
                devices[deviceId].history = [];
            }
            
            devices[deviceId].history.push({
                timestamp: new Date(data.real_timestamp * 1000),
                percentage: data.percentage,
                liters: data.liters,
                rssi: data.rssi
            });
            
            // Manter apenas √∫ltimos 50 registros
            if (devices[deviceId].history.length > 50) {
                devices[deviceId].history = devices[deviceId].history.slice(-50);
            }
            
            // Atualizar UI
            renderDevices();
            updateStats();
            updateLevelChart();
        }
        
        // Renderizar dispositivos
        function renderDevices() {
            const container = document.getElementById('devicesContainer');
            const devicesArray = Object.values(devices);
            
            if (devicesArray.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
                        <p style="font-size: 18px; margin-bottom: 10px;">‚è≥ Aguardando dados dos dispositivos...</p>
                        <p style="font-size: 14px;">Os dispositivos LoRa aparecer√£o aqui quando come√ßarem a transmitir</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            devicesArray.forEach(device => {
                const data = device.lastData;
                const isOnline = (new Date() - new Date(device.lastSeen)) < 5 * 60 * 1000; // 5 minutos
                const lastSeen = formatTimeAgo(device.lastSeen);
                
                // Calcular barras de sinal (0-5 barras baseado no RSSI)
                const signalBars = calculateSignalBars(data?.rssi || -100);
                
                html += `
                    <div class="device-card">
                        <div class="device-header">
                            <div class="device-id">üì± ${device.id}</div>
                            <div class="device-status ${isOnline ? 'status-online' : 'status-offline'}">
                                ${isOnline ? 'ONLINE' : 'OFFLINE'}
                            </div>
                        </div>
                        
                        ${data ? `
                            <div class="device-data">
                                <div class="data-item">
                                    <div class="data-value">${data.percentage}%</div>
                                    <div class="data-label">N√≠vel</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-value">${data.liters}L</div>
                                    <div class="data-label">Volume</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-value">${data.level}cm</div>
                                    <div class="data-label">Altura</div>
                                </div>
                            </div>
                            
                            <div class="signal-info">
                                <div class="signal-strength">
                                    <span>üì∂ Sinal:</span>
                                    <div class="signal-bars">
                                        ${signalBars.map((active, i) => 
                                            `<div class="signal-bar ${active ? 'active' : ''}"></div>`
                                        ).join('')}
                                    </div>
                                    <span>${data.rssi ? data.rssi.toFixed(1) : '--'} dBm</span>
                                </div>
                                <div>
                                    üìÖ Atualizado: ${lastSeen}
                                </div>
                            </div>
                            
                            ${data.snr ? `<div style="margin-top: 10px; font-size: 11px; color: #888;">
                                SNR: ${data.snr.toFixed(1)} dB | Pacotes: ${data.packet_count}
                            </div>` : ''}
                        ` : `
                            <div style="text-align: center; padding: 30px; color: #999;">
                                Aguardando dados...
                            </div>
                        `}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Atualizar estat√≠sticas
        function updateStats() {
            const devicesArray = Object.values(devices);
            const onlineDevices = devicesArray.filter(d => 
                (new Date() - new Date(d.lastSeen)) < 5 * 60 * 1000
            ).length;
            
            // Calcular RSSI m√©dio
            let totalRssi = 0;
            let rssiCount = 0;
            
            devicesArray.forEach(device => {
                if (device.lastData?.rssi) {
                    totalRssi += device.lastData.rssi;
                    rssiCount++;
                }
            });
            
            const avgRssi = rssiCount > 0 ? (totalRssi / rssiCount).toFixed(1) : '--';
            
            document.getElementById('totalDevices').textContent = onlineDevices;
            document.getElementById('totalPackets').textContent = devicesArray.reduce((sum, d) => 
                sum + (d.lastData?.packet_count || 0), 0
            );
            document.getElementById('avgSignal').textContent = avgRssi;
            document.getElementById('lastUpdate').textContent = formatTime(new Date());
        }
        
        // Atualizar estat√≠sticas do servidor
        function updateServerStats(data) {
            // Atualizar m√©tricas se dispon√≠veis
            if (data.connectedClients !== undefined) {
                // Pode ser usado para mostrar conex√µes ativas
            }
        }
        
        // Atualizar gr√°fico de n√≠vel
        function updateLevelChart() {
            const devicesArray = Object.values(devices);
            
            if (devicesArray.length === 0) {
                return;
            }
            
            // Usar primeiro dispositivo para o gr√°fico
            const device = devicesArray[0];
            if (!device.history || device.history.length === 0) {
                return;
            }
            
            const history = device.history.slice(-20); // √öltimos 20 pontos
            const labels = history.map(h => 
                formatTimeShort(new Date(h.timestamp))
            );
            const percentages = history.map(h => h.percentage);
            
            if (!levelChart) {
                const ctx = document.getElementById('levelChart').getContext('2d');
                levelChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'N√≠vel (%)',
                            data: percentages,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => value + '%'
                                }
                            }
                        }
                    }
                });
            } else {
                levelChart.data.labels = labels;
                levelChart.data.datasets[0].data = percentages;
                levelChart.update('none');
            }
        }
        
        // Adicionar log
        function addLog(message, type = 'info') {
            const logEntry = {
                time: new Date(),
                message: message,
                type: type
            };
            
            logs.unshift(logEntry);
            if (logs.length > 50) logs = logs.slice(0, 50);
            
            // Atualizar UI
            const logsContainer = document.getElementById('logs');
            let logsHtml = '';
            
            logs.forEach(log => {
                logsHtml += `
                    <div class="log-entry">
                        <span class="log-time">[${formatTime(log.time)}]</span>
                        <span class="log-${log.type}">${log.message}</span>
                    </div>
                `;
            });
            
            logsContainer.innerHTML = logsHtml;
        }
        
        // Atualizar status da conex√£o
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = connected ? 'üîó Conectado' : 'üîå Desconectado';
            statusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        // Fun√ß√µes auxiliares
        function calculateSignalBars(rssi) {
            if (!rssi) return [false, false, false, false, false];
            
            // RSSI melhor que -60 = 5 barras
            // -60 a -70 = 4 barras, etc
            const strength = Math.min(5, Math.max(0, Math.floor((rssi + 100) / 8)));
            return Array(5).fill(false).map((_, i) => i < strength);
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function formatTimeShort(date) {
            return date.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }
        
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            
            if (seconds < 60) return 'agora mesmo';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} min atr√°s`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} h atr√°s`;
            return `${Math.floor(seconds / 86400)} dias atr√°s`;
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            // Atualizar dados a cada 30 segundos mesmo sem novas mensagens
            setInterval(() => {
                if (Object.keys(devices).length > 0) {
                    renderDevices();
                    updateStats();
                }
            }, 30000);
            
            // Solicitar status do servidor a cada minuto
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'get_status' }));
                }
            }, 60000);
        });
    </script>
</body>
</html>
