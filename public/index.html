<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Caixa D'√Ågua</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .status-connected {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }

        .status-disconnected {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #F44336;
        }

        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
        }

        /* üéØ BARRA DE N√çVEL AUTO-AJUST√ÅVEL */
        .water-level-container {
            position: relative;
            background: #e0e0e0;
            border-radius: 25px;
            height: 40px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .water-level-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            border-radius: 25px;
            transition: width 0.5s ease, background-color 0.5s ease;
            box-shadow: 0 0 20px rgba(33, 150, 243, 0.4);
        }

        .water-level-fill.low {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .water-level-fill.very-low {
            background: linear-gradient(90deg, #F44336, #FF5252);
        }

        .water-level-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .water-level-text {
            text-align: center;
            margin-top: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .info-item {
            text-align: center;
            padding: 15px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .info-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .info-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* üéØ BOT√ïES */
        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #FF9800, #FFC107);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* üéØ GR√ÅFICO DE CONSUMO */
        .consumo-bars {
            display: flex;
            justify-content: space-between;
            align-items: end;
            height: 120px;
            margin-top: 20px;
            padding: 10px;
            background: rgba(33, 150, 243, 0.05);
            border-radius: 10px;
        }

        .bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            margin: 0 2px;
        }

        .bar {
            width: 100%;
            background: linear-gradient(to top, #2196F3, #21CBF3);
            border-radius: 5px 5px 0 0;
            transition: height 0.5s ease;
            max-width: 30px;
        }

        .bar-label {
            margin-top: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .bar-value {
            font-size: 0.7rem;
            color: #333;
            margin-top: 2px;
        }

        /* üéØ SEMANAL */
        .semanal-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .semana-item {
            text-align: center;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .semana-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .semana-label {
            font-size: 0.8rem;
            color: #666;
        }

        /* üéØ RESPONSIVO */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho -->
        <div class="header">
            <h1>üíß Caixa D'√Ågua</h1>
            <p>Monitoramento em Tempo Real</p>
        </div>

        <!-- Status de Conex√£o -->
        <div id="statusBar" class="status-bar status-disconnected">
            <div id="statusText">üî¥ Desconectado</div>
            <div id="statusTime" class="hidden"></div>
        </div>

        <!-- Card do N√≠vel da √Ågua -->
        <div class="card">
            <h2>üìä N√≠vel da Caixa</h2>
            
            <!-- üéØ BARRA AUTO-AJUST√ÅVEL -->
            <div class="water-level-container">
                <div id="waterLevelFill" class="water-level-fill" style="width: 0%"></div>
            </div>
            
            <div class="water-level-labels">
                <span id="minLevel">0cm</span>
                <span id="currentLevel">0cm (0%)</span>
                <span id="maxLevel">0cm</span>
            </div>
            
            <div class="water-level-text">
                <span id="levelText">Carregando...</span>
                <br>
                <small id="autoAjusteInfo" style="color: #666; font-size: 0.8rem;"></small>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-value" id="litersValue">0</div>
                    <div class="info-label">Litros</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="distanceValue">0</div>
                    <div class="info-label">Dist√¢ncia (cm)</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="volumeValue">0</div>
                    <div class="info-label">Volume Total (L)</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="alturaValue">0</div>
                    <div class="info-label">Altura (cm)</div>
                </div>
            </div>
        </div>

        <!-- Card de Consumo -->
        <div class="card">
            <h2>üìà Consumo - √öltimas 24h</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-value" id="consumoHora">0</div>
                    <div class="info-label">Esta Hora (L)</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="consumoHoje">0</div>
                    <div class="info-label">Hoje (L)</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="consumoMensal">0</div>
                    <div class="info-label">Este M√™s (L)</div>
                </div>
                <div class="info-item">
                    <div class="info-value" id="horaAtual">0</div>
                    <div class="info-label">Hora Atual</div>
                </div>
            </div>

            <!-- Gr√°fico de Barras -->
            <div id="consumoBars" class="consumo-bars">
                <!-- As barras ser√£o geradas via JavaScript -->
                <div class="loading">Carregando gr√°fico...</div>
            </div>
        </div>

        <!-- Card Semanal -->
        <div class="card">
            <h2>üìÖ Consumo Semanal (4 semanas)</h2>
            <div id="semanalContainer" class="semanal-container">
                <!-- Conte√∫do semanal ser√° gerado via JavaScript -->
                <div class="loading">Carregando dados semanais...</div>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="card">
            <h2>‚öôÔ∏è A√ß√µes</h2>
            <div class="buttons">
                <button class="btn btn-primary" onclick="resetConsumo()">
                    üîÑ Zerar Consumo
                </button>
                <button class="btn btn-secondary" onclick="resetBarra()">
                    üìä Resetar Barra
                </button>
                <button class="btn btn-primary" onclick="refreshData()">
                    üîç Atualizar Dados
                </button>
                <button class="btn btn-secondary" onclick="showSystemInfo()">
                    ‚ÑπÔ∏è Info Sistema
                </button>
            </div>
        </div>
    </div>

    <script>
        // üéØ VARI√ÅVEIS GLOBAIS
        let websocket = null;
        let isConnected = false;
        let lastUpdateTime = null;

        // üéØ ELEMENTOS DA BARRA AUTO-AJUST√ÅVEL
        const waterLevelFill = document.getElementById('waterLevelFill');
        const minLevelSpan = document.getElementById('minLevel');
        const currentLevelSpan = document.getElementById('currentLevel');
        const maxLevelSpan = document.getElementById('maxLevel');
        const levelTextSpan = document.getElementById('levelText');
        const autoAjusteInfoSpan = document.getElementById('autoAjusteInfo');

        // üéØ INICIALIZA√á√ÉO
        function init() {
            connectWebSocket();
            updateTime();
            setInterval(updateTime, 1000);
        }

        // üéØ CONEX√ÉO WEBSOCKET
        function connectWebSocket() {
            const server = "wss://testeservidor-6opr.onrender.com/ws";
            
            try {
                websocket = new WebSocket(server);
                
                websocket.onopen = function(event) {
                    console.log("‚úÖ Conectado ao servidor");
                    isConnected = true;
                    updateConnectionStatus(true, "Conectado");
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        processWebSocketData(data);
                    } catch (error) {
                        console.error("‚ùå Erro ao processar mensagem:", error);
                    }
                };
                
                websocket.onclose = function(event) {
                    console.log("‚ùå Conex√£o fechada");
                    isConnected = false;
                    updateConnectionStatus(false, "Desconectado");
                    // Tentar reconectar ap√≥s 5 segundos
                    setTimeout(connectWebSocket, 5000);
                };
                
                websocket.onerror = function(error) {
                    console.error("‚ùå Erro WebSocket:", error);
                    updateConnectionStatus(false, "Erro de conex√£o");
                };
                
            } catch (error) {
                console.error("‚ùå Erro ao conectar:", error);
                updateConnectionStatus(false, "Erro ao conectar");
            }
        }

        // üéØ PROCESSAR DADOS DO WEBSOCKET
        function processWebSocketData(data) {
            lastUpdateTime = new Date();
            
            switch(data.type) {
                case 'all_data':
                    updateWaterLevelData(data);
                    updateConsumoData(data);
                    break;
                    
                case 'consumo_data':
                    updateBarrasConsumo(data);
                    break;
                    
                case 'consumo_semanal_data':
                    updateConsumoSemanal(data);
                    break;
                    
                case 'status':
                    updateSystemStatus(data);
                    break;
            }
        }

        // üéØ ATUALIZAR BARRA DE N√çVEL AUTO-AJUST√ÅVEL
        function updateWaterLevelData(data) {
            // üéØ DADOS DA BARRA AUTO-AJUST√ÅVEL
            const nivelAtual = data.height || 0;
            const porcentagemNormal = data.percentage || 0;
            const porcentagemAuto = data.percentage_auto || 0;
            const barraMin = data.barra_min || 0;
            const barraMax = data.barra_max || data.altura_caixa || 110;
            const barraAutoAjuste = data.barra_auto_ajuste || false;
            
            // üéØ USAR PORCENTAGEM AUTO-AJUSTADA SE DISPON√çVEL
            const porcentagemUsar = barraAutoAjuste ? porcentagemAuto : porcentagemNormal;
            
            // üéØ ATUALIZAR BARRA VISUAL
            waterLevelFill.style.width = porcentagemUsar + '%';
            
            // üéØ COR DA BARRA BASEADA NO N√çVEL
            if (porcentagemUsar < 20) {
                waterLevelFill.className = 'water-level-fill very-low';
            } else if (porcentagemUsar < 40) {
                waterLevelFill.className = 'water-level-fill low';
            } else {
                waterLevelFill.className = 'water-level-fill';
            }
            
            // üéØ ATUALIZAR TEXTOS
            minLevelSpan.textContent = barraMin + 'cm';
            currentLevelSpan.textContent = nivelAtual + 'cm (' + porcentagemUsar + '%)';
            maxLevelSpan.textContent = barraMax + 'cm';
            
            levelTextSpan.textContent = getNivelText(porcentagemUsar);
            
            // üéØ INFO DO AUTO-AJUSTE
            if (barraAutoAjuste) {
                autoAjusteInfoSpan.textContent = `‚ö° Auto-ajuste: ${barraMin}cm a ${barraMax}cm`;
                autoAjusteInfoSpan.style.color = '#4CAF50';
            } else {
                autoAjusteInfoSpan.textContent = 'üìè Usando altura total da caixa';
                autoAjusteInfoSpan.style.color = '#666';
            }
            
            // üéØ ATUALIZAR OUTROS VALORES
            document.getElementById('litersValue').textContent = data.liters || 0;
            document.getElementById('distanceValue').textContent = (data.distance || 0).toFixed(1);
            document.getElementById('volumeValue').textContent = data.volume_total || 0;
            document.getElementById('alturaValue').textContent = data.altura_caixa || 0;
        }

        // üéØ TEXTO DESCRITIVO DO N√çVEL
        function getNivelText(percentage) {
            if (percentage >= 90) return 'üíß Cheia';
            if (percentage >= 70) return 'üíß N√≠vel Alto';
            if (percentage >= 50) return 'üíß N√≠vel M√©dio';
            if (percentage >= 30) return 'üíß N√≠vel Baixo';
            if (percentage >= 10) return '‚ö†Ô∏è N√≠vel Muito Baixo';
            return 'üö® Cr√≠tico - Abastecer!';
        }

        // üéØ ATUALIZAR DADOS DE CONSUMO
        function updateConsumoData(data) {
            document.getElementById('consumoHora').textContent = data.consumo_hora || 0;
            document.getElementById('consumoHoje').textContent = data.consumo_hoje || 0;
            document.getElementById('consumoMensal').textContent = data.consumo_mensal || 0;
            document.getElementById('horaAtual').textContent = (data.hora_atual || 0) + 'h';
        }

        // üéØ ATUALIZAR BARRAS DE CONSUMO
        function updateBarrasConsumo(data) {
            const consumoBars = document.getElementById('consumoBars');
            const valoresConsumo = data.valores_consumo || Array(24).fill(0);
            const consumoMaximoBarra = data.consumo_maximo_barra || 10000;
            
            consumoBars.innerHTML = '';
            
            const horaAtual = data.hora_atual || 0;
            
            valoresConsumo.forEach((consumo, index) => {
                const barContainer = document.createElement('div');
                barContainer.className = 'bar-container';
                
                // üéØ CALCULAR ALTURA DA BARRA (m√°ximo 100px)
                const altura = consumo > 0 ? Math.max(10, (consumo / consumoMaximoBarra) * 100) : 0;
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = altura + 'px';
                bar.title = consumo + 'L';
                
                // üéØ DESTACAR HORA ATUAL
                if (index === horaAtual) {
                    bar.style.background = 'linear-gradient(to top, #FF9800, #FFC107)';
                    bar.style.boxShadow = '0 0 10px rgba(255, 152, 0, 0.5)';
                }
                
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = index + 'h';
                
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = consumo > 0 ? consumo + 'L' : '';
                
                barContainer.appendChild(bar);
                barContainer.appendChild(barLabel);
                barContainer.appendChild(barValue);
                consumoBars.appendChild(barContainer);
            });
        }

        // üéØ ATUALIZAR CONSUMO SEMANAL
        function updateConsumoSemanal(data) {
            const semanalContainer = document.getElementById('semanalContainer');
            const consumoSemanal = data.consumo_semanal || Array(4).fill(0);
            const semanasConsumo = data.semanas_consumo || ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
            
            semanalContainer.innerHTML = '';
            
            consumoSemanal.forEach((consumo, index) => {
                const semanaItem = document.createElement('div');
                semanaItem.className = 'semana-item';
                
                const semanaValue = document.createElement('div');
                semanaValue.className = 'semana-value';
                semanaValue.textContent = consumo + 'L';
                
                const semanaLabel = document.createElement('div');
                semanaLabel.className = 'semana-label';
                semanaLabel.textContent = semanasConsumo[index] || `Sem ${index + 1}`;
                
                semanaItem.appendChild(semanaValue);
                semanaItem.appendChild(semanaLabel);
                semanalContainer.appendChild(semanaItem);
            });
        }

        // üéØ ATUALIZAR STATUS DO SISTEMA
        function updateSystemStatus(data) {
            // Implementar se necess√°rio
        }

        // üéØ ATUALIZAR STATUS DE CONEX√ÉO
        function updateConnectionStatus(connected, message) {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const statusTime = document.getElementById('statusTime');
            
            if (connected) {
                statusBar.className = 'status-bar status-connected';
                statusText.innerHTML = 'üü¢ ' + message;
                statusTime.classList.remove('hidden');
            } else {
                statusBar.className = 'status-bar status-disconnected';
                statusText.innerHTML = 'üî¥ ' + message;
                statusTime.classList.add('hidden');
            }
        }

        // üéØ ATUALIZAR HORA
        function updateTime() {
            const now = new Date();
            const statusTime = document.getElementById('statusTime');
            
            if (statusTime && !statusTime.classList.contains('hidden')) {
                statusTime.textContent = '√öltima atualiza√ß√£o: ' + 
                    (lastUpdateTime ? formatTime(lastUpdateTime) : 'Nunca');
            }
        }

        function formatTime(date) {
            return date.toLocaleTimeString('pt-BR') + ' ' + 
                   date.toLocaleDateString('pt-BR');
        }

        // üéØ BOT√ïES DE A√á√ÉO
        function resetConsumo() {
            if (websocket && isConnected) {
                websocket.send('reset_consumo');
                showNotification('üîÑ Zerando consumo...');
            } else {
                showNotification('‚ùå N√£o conectado', 'error');
            }
        }

        function resetBarra() {
            if (websocket && isConnected) {
                websocket.send('reset_barra');
                showNotification('üìä Resetando barra auto-ajuste...');
            } else {
                showNotification('‚ùå N√£o conectado', 'error');
            }
        }

        function refreshData() {
            if (websocket && isConnected) {
                websocket.send('get_data');
                websocket.send('get_consumo');
                websocket.send('get_consumo_semanal');
                showNotification('üîç Atualizando dados...');
            } else {
                showNotification('‚ùå N√£o conectado', 'error');
            }
        }

        function showSystemInfo() {
            const info = `
Sistema Caixa D'√Ågua

‚Ä¢ Barra Auto-Ajust√°vel: A barra se adapta automaticamente ao seu padr√£o de uso
‚Ä¢ M√≠nimo/M√°ximo: Baseado no hist√≥rico real de n√≠veis
‚Ä¢ Visual Otimizado: Mostra a varia√ß√£o real no celular
‚Ä¢ Atualiza√ß√£o em Tempo Real: Dados a cada 3 segundos

üí° Dica: Use "Resetar Barra" para reiniciar o auto-ajuste
            `;
            alert(info);
        }

        // üéØ NOTIFICA√á√ïES
        function showNotification(message, type = 'info') {
            // Implementar sistema de notifica√ß√µes mais elaborado
            console.log((type === 'error' ? '‚ùå ' : '‚úÖ ') + message);
            
            // Notifica√ß√£o simples
            if (type === 'error') {
                alert('Erro: ' + message);
            }
        }

        // üéØ INICIALIZAR QUANDO A P√ÅGINA CARREGAR
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
